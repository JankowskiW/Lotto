package pl.wj.lotto.domain.ticket.adapter;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import pl.wj.lotto.domain.common.drawdatetime.DrawDateTimeChecker;
import pl.wj.lotto.domain.common.drawdatetime.port.in.DrawDateTimeCheckerPort;
import pl.wj.lotto.domain.common.gametype.GameType;
import pl.wj.lotto.domain.common.gametype.GameTypeSettingsContainer;
import pl.wj.lotto.domain.common.numbers.NumbersGenerator;
import pl.wj.lotto.domain.common.numbers.NumbersValidator;
import pl.wj.lotto.domain.common.numbers.model.Numbers;
import pl.wj.lotto.domain.common.numbers.port.in.NumbersGeneratorPort;
import pl.wj.lotto.domain.common.numbers.port.in.NumbersValidatorPort;
import pl.wj.lotto.domain.common.numbersreceiver.NumbersReceiverPort;
import pl.wj.lotto.domain.draw.model.Draw;
import pl.wj.lotto.domain.draw.model.dto.DrawResultDto;
import pl.wj.lotto.domain.draw.port.out.DrawRepositoryPort;
import pl.wj.lotto.domain.ticket.mapper.TicketMapper;
import pl.wj.lotto.domain.ticket.model.Ticket;
import pl.wj.lotto.domain.ticket.model.dto.PlayerNumbersDto;
import pl.wj.lotto.domain.ticket.model.dto.TicketRequestDto;
import pl.wj.lotto.domain.ticket.model.dto.TicketResponseDto;
import pl.wj.lotto.domain.ticket.port.in.TicketServicePort;
import pl.wj.lotto.domain.ticket.port.out.TicketRepositoryPort;
import pl.wj.lotto.domain.ticket.service.TicketService;
import pl.wj.lotto.infrastructure.clock.config.ClockFakeConfig;
import pl.wj.lotto.infrastructure.numbersreceiver.fake.NumbersReceiverFakeAdapter;
import pl.wj.lotto.infrastructure.persistence.fake.draw.DrawFakeAdapter;
import pl.wj.lotto.infrastructure.persistence.fake.ticket.TicketFakeAdapter;

import java.time.Clock;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

import static org.assertj.core.api.Assertions.assertThat;
import static org.junit.jupiter.api.Assertions.assertAll;

class TicketServiceAdapterComponentTest {
    private TicketRepositoryPort ticketRepositoryPort;
    private TicketServicePort ticketServicePort;
    private DrawRepositoryPort drawRepositoryPort;

    private Clock clock;

    @BeforeEach
    void setUp() {
        clock = new ClockFakeConfig().clock();
        NumbersReceiverPort numbersReceiverPort = new NumbersReceiverFakeAdapter();
        NumbersGeneratorPort numbersGeneratorPort = new NumbersGenerator(numbersReceiverPort);
        NumbersValidatorPort numbersValidatorPort = new NumbersValidator();
        DrawDateTimeCheckerPort drawDateTimeCheckerPort = new DrawDateTimeChecker(clock);
        drawRepositoryPort = new DrawFakeAdapter();
        ticketRepositoryPort = new TicketFakeAdapter();
        TicketService ticketService = new TicketService(
                clock, ticketRepositoryPort, drawDateTimeCheckerPort, numbersGeneratorPort, numbersValidatorPort);
        ticketServicePort = new TicketServiceAdapter(ticketService);
    }

    @Test
    void shouldAddNewTicketWhenAnonymousUserHasChosenNumbers() {
        // given
        GameType gameType = GameType.LOTTO;
        List<Integer> mainNumbers = List.of(1,2,3,4,5,6);
        TicketRequestDto ticketRequestDto = TicketRequestDto.builder()
                .userId(null)
                .gameTypeId(gameType.getId())
                .numberOfDraws(1)
                .numbersAutogenerated(false)
                .mainNumbers(mainNumbers)
                .extraNumbers(null)
                .build();
        TicketResponseDto expectedResult = TicketMapper.toTicketResponseDto(ticketRequestDto);

        // when
        TicketResponseDto result = ticketServicePort.addTicket(ticketRequestDto);

        // then
        assertAll(
                () -> assertThat(result).isNotNull(),
                () -> assertThat(result.gameTypeName()).isEqualTo(expectedResult.gameTypeName()),
                () -> assertThat(result.numberOfDraws()).isEqualTo(expectedResult.numberOfDraws()),
                () -> assertThat(result.numbers().mainNumbers()).isEqualTo(expectedResult.numbers().mainNumbers()),
                () -> assertThat(result.numbers().extraNumbers()).isEqualTo(expectedResult.numbers().extraNumbers())
        );
    }

    @Test
    void shouldReturnTicketResponseDtoListOfSpecificUser() {
        // given
        String userId = "some-user-id";
        TicketRequestDto ticketRequestDto;
        ticketRequestDto = TicketRequestDto.builder()
                .userId("")
                .gameTypeId(GameType.LOTTO.getId())
                .numberOfDraws(1)
                .numbersAutogenerated(true)
                .mainNumbers(List.of(1,2,3,4,5,6))
                .build();
        Ticket ticket = TicketMapper.toTicket(ticketRequestDto);
        ticket.setGenerationDateTime(LocalDateTime.now(clock));
        ticketRepositoryPort.save(ticket);
        ticketRequestDto = TicketRequestDto.builder()
                .userId("some-other-user-id")
                .gameTypeId(GameType.LOTTO.getId())
                .numberOfDraws(1)
                .numbersAutogenerated(true)
                .mainNumbers(List.of(1,2,3,4,5,6))
                .build();
        ticket = TicketMapper.toTicket(ticketRequestDto);
        ticket.setGenerationDateTime(LocalDateTime.now(clock));
        ticketRepositoryPort.save(ticket);
        ticketRequestDto = TicketRequestDto.builder()
                .userId(userId)
                .gameTypeId(GameType.LOTTO.getId())
                .numberOfDraws(1)
                .numbersAutogenerated(true)
                .mainNumbers(List.of(1,2,3,4,5,6))
                .build();
        ticket = TicketMapper.toTicket(ticketRequestDto);
        ticket.setGenerationDateTime(LocalDateTime.now(clock));
        ticketRepositoryPort.save(ticket);
        ticketRequestDto = TicketRequestDto.builder()
                .userId(userId)
                .gameTypeId(GameType.LOTTO.getId())
                .numberOfDraws(1)
                .numbersAutogenerated(true)
                .mainNumbers(List.of(1,2,3,4,5,6))
                .build();
        ticket = TicketMapper.toTicket(ticketRequestDto);
        ticket.setGenerationDateTime(LocalDateTime.now(clock));
        ticketRepositoryPort.save(ticket);

        // when
        List<TicketResponseDto> result = ticketServicePort.getUserTickets(userId);

        // then
        assertAll(
                () -> assertThat(result).isNotNull().hasSize(2),
                () -> assertThat(result.stream().map(TicketResponseDto::userId).toList()).containsOnly(userId)
        );
    }

    @Test
    void shouldReturnPlayersDrawNumbersForGivenDrawResult() {
        // given
        LocalDateTime now = LocalDateTime.now(clock);
        GameType gameType = GameType.LOTTO;
        List<Integer> winningNumbers = List.of(1,2,3,4,5,6);
        List<PlayerNumbersDto> expectedResult = new ArrayList<>();
        DrawResultDto drawResultDto = DrawResultDto.builder()
                .type(gameType)
                .drawDateTime(now)
                .numbers(Numbers.builder()
                        .gameType(gameType)
                        .drawDateTimeSettings(GameTypeSettingsContainer.getGameTypeSettings(gameType).drawDateTimeSettings())
                        .mainNumbers(winningNumbers)
                        .build())
                .build();
        drawRepositoryPort.save(
                Draw.builder()
                        .type(gameType)
                        .drawDateTime(now)
                        .numbers(Numbers.builder()
                                .gameType(gameType)
                                .drawDateTimeSettings(GameTypeSettingsContainer.getGameTypeSettings(gameType).drawDateTimeSettings())
                                .mainNumbers(winningNumbers)
                                .build())
                        .build());
        Ticket ticket = ticketRepositoryPort.save(
                Ticket.builder()
                        .userId("some-user-id")
                        .gameType(gameType)
                        .numberOfDraws(1)
                        .numbers(Numbers.builder()
                                .gameType(gameType)
                                .drawDateTimeSettings(GameTypeSettingsContainer.getGameTypeSettings(gameType).drawDateTimeSettings())
                                .mainNumbers(winningNumbers)
                                .build())
                        .generationDateTime(now.minusHours(2))
                        .lastDrawDateTime(now.plusHours(2))
                        .build());
        expectedResult.add(
                PlayerNumbersDto.builder()
                        .userId(ticket.getUserId())
                        .gameType(gameType)
                        .mainNumbers(ticket.getNumbers().mainNumbers())
                .build());
        ticket = ticketRepositoryPort.save(
                Ticket.builder()
                        .userId("some-user-id")
                        .gameType(gameType)
                        .numberOfDraws(1)
                        .numbers(Numbers.builder()
                                .gameType(gameType)
                                .drawDateTimeSettings(GameTypeSettingsContainer.getGameTypeSettings(gameType).drawDateTimeSettings())
                                .mainNumbers(List.of(1,2,3,4,5,7))
                                .build())
                        .generationDateTime(now.minusHours(1))
                        .lastDrawDateTime(now.plusHours(2))
                        .build());
        expectedResult.add(
                PlayerNumbersDto.builder()
                        .userId(ticket.getUserId())
                        .gameType(gameType)
                        .mainNumbers(ticket.getNumbers().mainNumbers())
               .build());

        // when
        List<PlayerNumbersDto> result = ticketServicePort.getPlayersDrawNumbers(drawResultDto);

        // then
        assertThat(result)
                .usingRecursiveFieldByFieldElementComparator()
                .containsExactlyInAnyOrderElementsOf(expectedResult);
    }
}